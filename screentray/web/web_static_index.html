<!doctype html>
<html lang="en">
<head>
<meta charset="utf-t">
<title>ScreenTracker — Dashboard</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  :root {
    color-scheme: light dark;
    --bg-light: #fff; --text-light: #111;
    --bg-dark: #111; --text-dark: #eee;
    --bar-light: #eee; --bar-dark: #333;
    --border-light: #ccc; --border-dark: #666;
    --active: #2e8b57; --inactive: #777;
    --highlight: #ff0; --hover: #4a9d6f;
  }
  body {
    font-family: system-ui, Segoe UI, Roboto, Arial;
    margin: 0; padding: 10px;
    background: var(--bg); color: var(--text);
  }
  .tabs {
    display: flex;
    gap: 5px;
    border-bottom: 2px solid var(--border);
    margin-bottom: 10px;
  }
  .tab {
    padding: 10px 20px;
    cursor: pointer;
    background: var(--bar);
    border: 1px solid var(--border);
    border-bottom: none;
  }
  .tab.active {
    background: var(--bg);
    font-weight: bold;
  }
  .tab-content {
    display: none;
  }
  .tab-content.active {
    display: block;
  }
  .controls { margin: 10px 0; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
  .period {
    cursor: pointer;
    padding: 8px;
    border-bottom: 1px solid var(--border);
    transition: background 0.2s;
  }
  .period:hover { background: var(--hover); opacity: 0.8; }
  .period.active { background: var(--active); color: white; }
  .period.inactive { background: var(--inactive); color: white; }
  .period.selected { outline: 3px solid var(--highlight); }
  .period-header { font-weight: bold; display: flex; justify-content: space-between; }
  .period-nav { display: flex; gap: 5px; margin: 10px 0; }
  .details {
    margin: 15px 0;
    padding: 10px;
    border: 1px solid var(--border);
    background: var(--bar);
    display: none;
  }
  .details.show { display: block; }
  .event-list { margin: 10px 0; }
  .event-item {
    padding: 5px;
    margin: 3px 0;
    background: var(--bg);
    border-left: 3px solid var(--active);
    font-family: monospace;
    font-size: 0.9em;
  }
  .stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 10px;
    margin: 10px 0;
  }
  .stat-box {
    padding: 10px;
    border: 1px solid var(--border);
    background: var(--bar);
  }
  button, select, input {
    background: var(--bar); color: var(--text);
    border: 1px solid var(--border);
    padding: 6px 12px; cursor: pointer;
  }
  button:disabled { opacity: 0.5; cursor: not-allowed; }
  .chart {
    margin: 20px 0;
    padding: 10px;
    border: 1px solid var(--border);
    background: var(--bar);
  }
  .bar-chart {
    display: flex;
    align-items: flex-end;
    height: 200px;
    gap: 2px;
    margin-top: 10px;
  }
  .bar {
    flex: 1;
    background: var(--active);
    position: relative;
    cursor: pointer;
    transition: opacity 0.2s;
  }
  .bar:hover { opacity: 0.7; }
  .bar-label {
    position: absolute;
    bottom: -20px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 0.8em;
    white-space: nowrap;
  }
  .bar-value {
    position: absolute;
    top: -20px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 0.8em;
    font-weight: bold;
  }
  .week-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 5px;
    margin: 10px 0;
  }
  .day-cell {
    padding: 10px;
    border: 1px solid var(--border);
    background: var(--bar);
    cursor: pointer;
    text-align: center;
    transition: background 0.2s;
  }
  .day-cell:hover { background: var(--hover); }
  .day-cell.today { border: 2px solid var(--active); }
  .hidden { display: none; }
  .toggle-btn {
    margin-top: 10px;
    font-size: 0.9em;
  }

  /* --- New UI Layout Styles --- */

  /* Move stats to top right and make smaller */
  #current-stats {
    position: absolute;
    top: 25px; /* Below main <h2> */
    right: 10px;
    display: flex;
    gap: 15px;
    font-size: 0.8em;
    grid-template-columns: none; /* Override .stats default */
    margin: 0; /* Override .stats default */
  }
  #current-stats .stat-box {
    display: flex;
    gap: 5px;
    align-items: baseline;
    padding: 0;
    border: none;
    background: none;
  }
  #current-stats .stat-box h4 {
    margin: 0;
    font-size: 1em;
    font-weight: normal;
    opacity: 0.8;
  }
  #current-stats .stat-box p {
    margin: 0 !important;
    font-size: 1em !important; /* Override JS inline style */
    font-weight: bold;
  }

  /* Create two-column layout for overview tab */
  .overview-layout {
    display: flex;
    gap: 20px;
    margin-top: 10px;
  }
  .period-list-container {
    flex: 1;
    min-width: 300px;
    max-width: 40%;
  }
  #periods {
    max-height: 60vh;
    overflow-y: auto;
    border: 1px solid var(--border);
    background: var(--bar);
  }
  /* Override defaults for details panel in new layout */
  #period-details {
    flex: 2; /* Take remaining space */
    margin: 0; /* Reset margin */
    height: fit-content; /* Don't stretch full height */
    /* .details.show logic from JS will still work */
  }

</style>
</head>
<body>
<h2>ScreenTracker Dashboard</h2>

<div class="tabs">
  <div class="tab active" data-tab="overview">Overview</div>
  <div class="tab" data-tab="daily">Daily</div>
  <div class="tab" data-tab="weekly">Weekly</div>
  <div class="tab" data-tab="events">Events</div>
</div>

<div class="tab-content active" id="overview">
  <div class="controls">
    <button id="refresh">Refresh</button>
    <select id="theme">
      <option value="system">System Theme</option>
      <option value="light">Light</option>
      <option value="dark">Dark</option>
    </select>
    <select id="hours">
      <option value="24">Last 24h</option>
      <option value="12">Last 12h</option>
      <option value="6">Last 6h</option>
      <option value="1">Last 1h</option>
    </select>
  </div>

  <div class="stats" id="current-stats"></div>

  <div class="overview-layout">

    <div class="period-list-container">
      <h3>Activity Periods</h3>
      <div class="period-nav">
        <button id="prev-period">← Prev</button>
        <span id="period-index">-</span>
        <button id="next-period">Next →</button>
      </div>
      <div id="periods"></div>
    </div>

    <div class="details" id="period-details">
      <h4>Period Details</h4>
      <div id="detail-content"></div>
    </div>

  </div> </div>

<div class="tab-content" id="daily">
  <div class="controls">
    <input type="date" id="daily-date">
    <button id="daily-prev">← Prev Day</button>
    <button id="daily-next">Next Day →</button>
  </div>

  <div class="stats" id="daily-stats"></div>

  <div class="chart">
    <h3>Activity by Hour</h3>
    <div class="bar-chart" id="hourly-chart"></div>
  </div>
</div>

<div class="tab-content" id="weekly">
  <div class="controls">
    <button id="week-prev">← Prev Week</button>
    <span id="week-label"></span>
    <button id="week-next">Next Week →</button>
  </div>

  <div class="week-grid" id="week-grid"></div>

  <div class="chart">
    <h3>Weekly Activity</h3>
    <div class="bar-chart" id="weekly-chart"></div>
  </div>
</div>

<div class="tab-content" id="events">
  <div class="controls">
    <input id="event-search" placeholder="Search events..."/>
    <button id="event-search-btn">Search</button>
    <select id="event-limit">
      <option value="50">50</option>
      <option value="100">100</option>
      <option value="200" selected>200</option>
      <option value="500">500</option>
    </select>
  </div>
  <div class="event-list" id="event-list"></div>
</div>

<script>
// --- ALL JAVASCRIPT IS UNCHANGED ---
const API = "/api";
let periods = [];
let selectedIndex = -1;
let currentDate = new Date();
let currentWeekStart = new Date();

// Theme management
function applyTheme(mode) {
  const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
  const dark = mode === "dark" || (mode === "system" && prefersDark);
  document.documentElement.style.setProperty("--bg", dark ? "var(--bg-dark)" : "var(--bg-light)");
  document.documentElement.style.setProperty("--text", dark ? "var(--text-dark)" : "var(--text-light)");
  document.documentElement.style.setProperty("--bar", dark ? "var(--bar-dark)" : "var(--bar-light)");
  document.documentElement.style.setProperty("--border", dark ? "var(--border-dark)" : "var(--border-light)");
}

function loadTheme() {
  const saved = localStorage.getItem("theme") || "system";
  document.getElementById("theme").value = saved;
  applyTheme(saved);
}

document.getElementById("theme").onchange = e => {
  localStorage.setItem("theme", e.target.value);
  applyTheme(e.target.value);
};

// Tab switching
document.querySelectorAll(".tab").forEach(tab => {
  tab.onclick = () => {
    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));
    tab.classList.add("active");
    document.getElementById(tab.dataset.tab).classList.add("active");

    if (tab.dataset.tab === "daily") loadDailyView();
    if (tab.dataset.tab === "weekly") loadWeeklyView();
    if (tab.dataset.tab === "events") loadEventsList();
  };
});

// Format helpers
function formatDuration(sec) {
  const h = Math.floor(sec / 3600);
  const m = Math.floor((sec % 3600) / 60);
  const s = Math.floor(sec % 60);
  if (h > 0) return `${h}h ${m}m`;
  if (m > 0) return `${m}m`;
  return `${s}s`;
}

function formatTime(iso) {
  return new Date(iso).toLocaleTimeString();
}

function formatDate(date) {
  return date.toISOString().split('T')[0];
}

// OVERVIEW TAB
async function loadPeriods() {
  const hours = document.getElementById("hours").value;
  const resp = await fetch(`${API}/periods?hours=${hours}`);
  periods = await resp.json();

  const container = document.getElementById("periods");
  container.innerHTML = "";

  if (periods.error) {
    container.innerText = periods.error;
    return;
  }

  periods.forEach((p, idx) => {
    const div = document.createElement("div");
    div.className = `period ${p.state}`;
    div.onclick = () => selectPeriod(idx);

    div.innerHTML = `
      <div class="period-header">
        <span>${p.state.toUpperCase()}</span>
        <span>${formatDuration(p.duration_sec)}</span>
      </div>
      <div style="font-size:0.9em;opacity:0.8;">
        ${formatTime(p.start)} → ${formatTime(p.end)}
      </div>
    `;
    container.appendChild(div);
  });

  // Update current stats
  const now = new Date();
  const activeTime = periods.filter(p => p.state === 'active').reduce((sum, p) => sum + p.duration_sec, 0);
  const inactiveTime = periods.filter(p => p.state === 'inactive').reduce((sum, p) => sum + p.duration_sec, 0);

  document.getElementById("current-stats").innerHTML = `
    <div class="stat-box">
      <h4>Active (${hours}h)</h4>
      <p style="font-size:1.5em;margin:5px 0;">${formatDuration(activeTime)}</p>
    </div>
    <div class="stat-box">
      <h4>Inactive (${hours}h)</h4>
      <p style="font-size:1.5em;margin:5px 0;">${formatDuration(inactiveTime)}</p>
    </div>
  `;

  const lastActive = periods.findIndex(p => p.state === "active");
  if (lastActive >= 0) selectPeriod(lastActive);
}

function selectPeriod(idx) {
  selectedIndex = idx;
  const p = periods[idx];

  document.querySelectorAll(".period").forEach((el, i) => {
    el.classList.toggle("selected", i === idx);
  });

  document.getElementById("period-index").innerText = `Period ${idx + 1} / ${periods.length}`;
  document.getElementById("prev-period").disabled = idx === 0;
  document.getElementById("next-period").disabled = idx === periods.length - 1;

  const details = document.getElementById("period-details");
  const content = document.getElementById("detail-content");

  let html = `
    <p><strong>State:</strong> ${p.state}</p>
    <p><strong>Duration:</strong> ${formatDuration(p.duration_sec)}</p>
    <p><strong>Start:</strong> ${p.start}</p>
    <p><strong>End:</strong> ${p.end}</p>
  `;

  if (p.trigger_event) {
    html += `
      <p><strong>Triggered by:</strong> ${p.trigger_event.type}</p>
      <p style="font-size:0.9em;opacity:0.8;">${p.trigger_event.timestamp}</p>
    `;
  }

  if (p.events && p.events.length > 0) {
    html += `
      <button class="toggle-btn" onclick="togglePeriodEvents()">
        Show Events (${p.events.length})
      </button>
      <div class="event-list hidden" id="period-events">
    `;
    p.events.forEach(e => {
      html += `
        <div class="event-item">
          <strong>${e.type}</strong> @ ${formatTime(e.timestamp)}
          ${e.detail ? `<br><span style="opacity:0.7">${e.detail}</span>` : ''}
        </div>
      `;
    });
    html += '</div>';
  }

  content.innerHTML = html;
  details.classList.add("show");
}

function togglePeriodEvents() {
  const el = document.getElementById("period-events");
  el.classList.toggle("hidden");
  event.target.textContent = el.classList.contains("hidden")
    ? `Show Events (${periods[selectedIndex].events.length})`
    : `Hide Events (${periods[selectedIndex].events.length})`;
}

document.getElementById("prev-period").onclick = () => {
  if (selectedIndex > 0) selectPeriod(selectedIndex - 1);
};

document.getElementById("next-period").onclick = () => {
  if (selectedIndex < periods.length - 1) selectPeriod(selectedIndex + 1);
};

// DAILY TAB
async function loadDailyView() {
  const dateStr = formatDate(currentDate);
  document.getElementById("daily-date").value = dateStr;

  const resp = await fetch(`${API}/stats/${dateStr}`);
  const stats = await resp.json();

  document.getElementById("daily-stats").innerHTML = `
    <div class="stat-box">
      <h4>Active Time</h4>
      <p style="font-size:1.5em;margin:5px 0;">${formatDuration(stats.active_seconds)}</p>
    </div>
    <div class="stat-box">
      <h4>Inactive Time</h4>
      <p style="font-size:1.5em;margin:5px 0;">${formatDuration(stats.inactive_seconds)}</p>
    </div>
    <div class="stat-box">
      <h4>Events</h4>
      ${Object.entries(stats.event_counts).map(([type, count]) =>
        `<p>${type}: ${count}</p>`
      ).join('')}
    </div>
  `;

  // Load hourly breakdown
  const hourlyResp = await fetch(`${API}/periods?hours=24`);
  const allPeriods = await hourlyResp.json();

  const hourlyData = new Array(24).fill(0);
  allPeriods.forEach(p => {
    if (p.state !== 'active') return;
    const start = new Date(p.start);
    const end = new Date(p.end);
    if (start.toDateString() !== currentDate.toDateString()) return;

    const startHour = start.getHours();
    const endHour = end.getHours();

    if (startHour === endHour) {
      hourlyData[startHour] += p.duration_sec / 60;
    } else {
      hourlyData[startHour] += (60 - start.getMinutes());
      for (let h = startHour + 1; h < endHour; h++) {
        hourlyData[h] += 60;
      }
      hourlyData[endHour] += end.getMinutes();
    }
  });

  const maxMinutes = Math.max(...hourlyData, 1);
  const chart = document.getElementById("hourly-chart");
  chart.innerHTML = '';

  hourlyData.forEach((minutes, hour) => {
    const bar = document.createElement("div");
    bar.className = "bar";
    bar.style.height = `${(minutes / maxMinutes) * 100}%`;
    bar.innerHTML = `
      <div class="bar-value">${Math.round(minutes)}m</div>
      <div class="bar-label">${hour}h</div>
    `;
    chart.appendChild(bar);
  });
}

document.getElementById("daily-date").onchange = (e) => {
  currentDate = new Date(e.target.value);
  loadDailyView();
};

document.getElementById("daily-prev").onclick = () => {
  currentDate.setDate(currentDate.getDate() - 1);
  loadDailyView();
};

document.getElementById("daily-next").onclick = () => {
  currentDate.setDate(currentDate.getDate() + 1);
  loadDailyView();
};

// WEEKLY TAB
async function loadWeeklyView() {
  const weekStart = new Date(currentWeekStart);
  // Monday start: adjust to previous Monday
  const day = weekStart.getDay();
  const diff = day === 0 ? -6 : 1 - day;
  weekStart.setDate(weekStart.getDate() + diff);

  const weekEnd = new Date(weekStart);
  weekEnd.setDate(weekEnd.getDate() + 6);

  document.getElementById("week-label").textContent =
    `${formatDate(weekStart)} — ${formatDate(weekEnd)}`;

  const grid = document.getElementById("week-grid");
  grid.innerHTML = '';

  const weeklyData = [];
  const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

  for (let i = 0; i < 7; i++) {
    const day = new Date(weekStart);
    day.setDate(day.getDate() + i);

    const resp = await fetch(`${API}/stats/${formatDate(day)}`);
    const stats = await resp.json();

    const cell = document.createElement("div");
    cell.className = "day-cell";
    if (formatDate(day) === formatDate(new Date())) {
      cell.classList.add("today");
    }
    cell.onclick = () => {
      currentDate = day;
      document.querySelector('[data-tab="daily"]').click();
    };

    cell.innerHTML = `
      <strong>${days[i]}</strong><br>
      ${day.getDate()}<br>
      <small>${formatDuration(stats.active_seconds)}</small>
    `;
    grid.appendChild(cell);
    weeklyData.push(stats.active_seconds / 60);
  }

  // Weekly chart
  const maxMinutes = Math.max(...weeklyData, 1);
  const chart = document.getElementById("weekly-chart");
  chart.innerHTML = '';

  weeklyData.forEach((minutes, i) => {
    const bar = document.createElement("div");
    bar.className = "bar";
    bar.style.height = `${(minutes / maxMinutes) * 100}%`;
    bar.innerHTML = `
      <div class="bar-value">${formatDuration(minutes * 60)}</div>
      <div class="bar-label">${days[i]}</div>
    `;
    chart.appendChild(bar);
  });
}

document.getElementById("week-prev").onclick = () => {
  currentWeekStart.setDate(currentWeekStart.getDate() - 7);
  loadWeeklyView();
};

document.getElementById("week-next").onclick = () => {
  currentWeekStart.setDate(currentWeekStart.getDate() + 7);
  loadWeeklyView();
};

// EVENTS TAB
async function loadEventsList(q = "") {
  const limit = document.getElementById("event-limit").value;
  const resp = await fetch(`${API}/events?limit=${limit}&offset=0${q ? "&q=" + encodeURIComponent(q) : ""}`);
  const events = await resp.json();

  const container = document.getElementById("event-list");
  container.innerHTML = "";

  events.forEach(e => {
    const div = document.createElement("div");
    div.className = "event-item";
    div.innerHTML = `
      <strong>${e.type}</strong> @ ${e.timestamp}
      ${e.detail ? `<br><span style="opacity:0.7">${e.detail}</span>` : ''}
    `;
    container.appendChild(div);
  });
}

document.getElementById("event-search-btn").onclick = () => {
  loadEventsList(document.getElementById("event-search").value);
};

document.getElementById("event-limit").onchange = () => {
  loadEventsList(document.getElementById("event-search").value);
};

// Global refresh
document.getElementById("refresh").onclick = () => {
  loadPeriods();
};

document.getElementById("hours").onchange = loadPeriods;

// Initialize
window.onload = () => {
  loadTheme();
  currentDate = new Date();
  currentWeekStart = new Date();
  loadPeriods();
};
</script>
</body>
</html>